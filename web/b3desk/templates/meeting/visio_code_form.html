<h4>{% trans %}Saisir le code de connexion {{ of_the_meeting }}{% endtrans %}</h4>
<p>
    {% trans %}Remplissez le code de connexion reçu dans l’invitation {{ of_the_meeting }}.{% endtrans %}<br><br>
</p>
<form id="visio-code-form" action="{{ url_for("meetings.visio_code") }}" method="POST">
    {% include 'meeting/csrf.html' %}
    <input type="hidden" id="visio-code" name="visio_code" value="" />
</form>
<div class="fr-container--fluid fr-mb-3w">
    <div class="visio-code-container">
        <input type="text" minlength="3" maxlength="3" id="visio-code1" class="fr-input" placeholder="- - -">
        <input type="text" minlength="3" maxlength="3" id="visio-code2" class="fr-input" placeholder="- - -">
        <input type="text" minlength="3" maxlength="3" id="visio-code3" class="fr-input" placeholder="- - -">
    </div>
</div>
<div class="fr-container--fluid">
    <div class="fr-grid-row">
        <button id="submit-visio-code" class="fr-btn fr-btn--primary" disabled title="{% trans %}Connexion{% endtrans %}">
            {% trans %}Connexion{% endtrans %}
        </button>
    </div>
</div>

{% block js %}
<script>
    const inputValidation = (target) => {
        moveToNextInputIfNeeded(target);
        visualValidation(target);
    }

    const moveToNextInputIfNeeded = (target) => {
        const isFilled = target.value.length >= 3;
        const isAtEnd = target.selectionStart == 3 && target.selectionEnd == 3;
        const nextSibling = target.nextElementSibling;
        const nextSiblingInput = nextSibling && target.nextElementSibling.nodeName === "INPUT";
        if (isFilled && nextSiblingInput && isAtEnd) {
            nextSibling.focus();
            nextSibling.selectionStart = 0;
            nextSibling.selectionEnd = 0;
        }
    }

    const moveToPreviousInputIfNeeded = (target) => {
        const isAtBeginning = target.selectionStart == 0 && target.selectionEnd == 0;
        const previousSibling = target.previousElementSibling;
        const previousSiblingInput = previousSibling && target.previousElementSibling.nodeName === "INPUT";
        if (isAtBeginning && previousSiblingInput) {
            previousSibling.focus();
            previousSibling.selectionStart = 3;
            previousSibling.selectionEnd = 3;
        }
    }

    const visualValidation = (target) => {
        if (target.value == "") {
            target.classList.remove("fr-input--valid")
            target.classList.remove("fr-input--error")
        } else if (!target.value.match(/\d{3}$/) && !target.classList.contains("fr-input--error")) {
            target.classList.remove("fr-input--valid")
            target.classList.add("fr-input--error")
        } else if (target.value.match(/\d{3}$/) && !target.classList.contains("fr-input--valid")) {
            target.classList.remove("fr-input--error")
            target.classList.add("fr-input--valid")
        }
    }

    const userInput = (event) => inputValidation(event.target);

    const inputs = document.querySelectorAll(".visio-code-container input");

    document.querySelector(".visio-code-container").addEventListener("input", userInput)


    inputs.forEach((input, index) => {
        input.addEventListener("keyup", function(event) {
            if (input.value.length >= 3 && event.key.length == 1) {
                moveToNextInputIfNeeded(input);
            }
            if (event.key == "Backspace" || event.key == "ArrowLeft") {
                moveToPreviousInputIfNeeded(input);
            } else if (event.key == "ArrowRight") {
                moveToNextInputIfNeeded(input);
            }
            visualValidation(input);

            const visioCode = Array.from(inputs).map(i => i.value).join("");
            if (visioCode.match(/\d{9}$/)) {
                document.getElementById("submit-visio-code").disabled = false;
                if (event.key == "Enter") {
                    document.getElementById("visio-code").value = visioCode;
                    document.getElementById("visio-code-form").submit();
                }
            } else {
                document.getElementById("submit-visio-code").disabled = true;
            }
        })
        input.addEventListener('paste', (e) => {
            const pasteData = (e.clipboardData || window.clipboardData).getData('text');
            const chars = [pasteData.slice(0,3), pasteData.slice(3,6), pasteData.slice(6,9)];
            inputs.forEach((input, index) => {
                input.value = chars[index];
                if (index == 2) {
                    input.focus();
                    input.selectionStart = 3;
                    input.selectionEnd = 3;
                }
            })
        });
    })
</script>
{% endblock %}
