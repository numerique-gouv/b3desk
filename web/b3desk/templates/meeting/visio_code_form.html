<h4>{% trans %}Saisir le code de connexion {{ of_the_meeting }}{% endtrans %}</h4>
<p>
    {% trans %}Remplissez le code de connexion reçu dans l’invitation {{ of_the_meeting }}.{% endtrans %}<br><br>
</p>
<form id="visio-code-form" action="{{ url_for("meetings.visio_code") }}" method="POST">
    {% include 'meeting/csrf.html' %}
    <input type="hidden" id="visio-code" name="visio_code" value="" />
</form>
<div class="fr-container--fluid fr-mb-3w">
    <div class="visio-code-container">
        <input type="text" minlength="3" maxlength="3" id="" class="fr-input" placeholder="- - -">
        <input type="text" minlength="3" maxlength="3" id="" class="fr-input" placeholder="- - -">
        <input type="text" minlength="3" maxlength="3" id="" class="fr-input" placeholder="- - -">
    </div>
</div>
<div class="fr-container--fluid">
    <div class="fr-grid-row">
        <button id="submit-visio-code" class="fr-btn fr-btn--primary" disabled title="{% trans %}Connexion{% endtrans %}">
            {% trans %}Connexion{% endtrans %}
        </button>
    </div>
</div>

{% block js %}
<script>
    const inputValidation = (target) => {
        moveToNextInputIfNeeded(target);
        visualValidation(target);
    }

    const moveToNextInputIfNeeded = (target) => {
        const isFilled = target.value.length >= 3;
        const nextSibling = target.nextElementSibling;
        const nextSiblingInput = nextSibling && target.nextElementSibling.nodeName === "INPUT";
        if (isFilled && nextSiblingInput) {
            nextSibling.focus();
        }
    }

    const moveToPreviouInputIfNeeded = (target) => {
        const isAtBeginning = target.selectionStart == 0;
        const previousSibling = target.previousElementSibling;
        const previousSiblingInput = previousSibling && target.previousElementSibling.nodeName === "INPUT";
        if (isAtBeginning && previousSiblingInput) {
            previousSibling.focus();
            previousSibling.selectionEnd = 2;
        }
    }

    const visualValidation = (target) => {
        if (target.value == "") {
            target.classList.remove("fr-input--valid")
            target.classList.remove("fr-input--error")
        } else if (!target.value.match(/\d{3}$/) && !target.classList.contains("fr-input--error")) {
            target.classList.remove("fr-input--valid")
            target.classList.add("fr-input--error")
        } else if (target.value.match(/\d{3}$/) && !target.classList.contains("fr-input--valid")) {
            target.classList.remove("fr-input--error")
            target.classList.add("fr-input--valid")
        }
    }

    const userInput = (event) => inputValidation(event.target);

    const inputs = document.querySelectorAll(".visio-code-container input");

    document.querySelector(".visio-code-container").addEventListener("input", userInput)


    inputs.forEach((input) => {
        input.addEventListener("keydown", function(event) {
            const nextSibling = input.nextElementSibling;
            const previousSibling = input.previousElementSibling;
            if (input.value.length >= 3 && event.key.length == 1) {
                moveToNextInputIfNeeded(input)
            }
            if (event.key == "Backspace" || event.key == "ArrowLeft") {
                moveToPreviouInputIfNeeded(input);
            } else if (event.key == "ArrowRight" && nextSibling) {
                nextSibling.focus();
            }
            visualValidation(input);

            const visioCode = Array.from(inputs).map(i => i.value).join("");

            if (visioCode.match(/\d{9}$/)) {
                document.getElementById("submit-visio-code").disabled = false;
                if (event.key == "Enter") {
                    document.getElementById("visio-code").value = visioCode;
                    document.getElementById("visio-code-form").submit();
                }
            } else {
                document.getElementById("submit-visio-code").disabled = true;

            }
        })
        input.addEventListener('paste', (e) => {
            const pasteData = (e.clipboardData || window.clipboardData).getData('text');
            const chars = pasteData.split('');
            for (let i = 9; i <= chars.length && i/4>>0 < inputs.length; i++) {
                inputs[i/4>>0].value += chars[i];
            }
            const nextIndex = index + chars.length;
            if (nextIndex < inputs.length) {
                inputs[nextIndex].focus();
            }
            if (nextIndex >= inputs.length) {
                inputs[inputs.length-1].focus();
            }
        });
    })
</script>
{% endblock %}
